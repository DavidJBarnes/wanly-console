name: Deploy wanly-console

on:
  push:
    branches: [main]

env:
  AWS_REGION: us-west-2
  ECR_REPOSITORY: wanly-console
  CONTAINER_NAME: wanly-console

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Deploy to EC2 via SSM
        id: ssm-command
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters commands='[
              "set -e",
              "aws ecr get-login-password --region '"${{ env.AWS_REGION }}"' | docker login --username AWS --password-stdin '"${{ steps.login-ecr.outputs.registry }}"'",
              "docker pull '"${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}"':latest",
              "docker stop '"${{ env.CONTAINER_NAME }}"' || true",
              "docker rm '"${{ env.CONTAINER_NAME }}"' || true",
              "docker run -d --name '"${{ env.CONTAINER_NAME }}"' --restart unless-stopped --network host -v /etc/letsencrypt:/etc/letsencrypt:ro '"${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}"':latest",
              "for i in 1 2 3 4 5; do curl -sf -k https://localhost/ && break || sleep 5; done",
              "docker image prune -af --filter until=48h"
            ]' \
            --query "Command.CommandId" \
            --output text)
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT

      - name: Wait for deployment
        run: |
          aws ssm wait command-executed \
            --command-id "${{ steps.ssm-command.outputs.command_id }}" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" || true
          STATUS=$(aws ssm get-command-invocation \
            --command-id "${{ steps.ssm-command.outputs.command_id }}" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query "Status" --output text)
          echo "Deployment status: $STATUS"
          if [ "$STATUS" != "Success" ]; then
            aws ssm get-command-invocation \
              --command-id "${{ steps.ssm-command.outputs.command_id }}" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --query "StandardErrorContent" --output text
            exit 1
          fi
